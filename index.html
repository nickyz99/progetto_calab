<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Vendite</title>
  <style>
    body { font-family:Arial,sans-serif; margin:2rem; }
    nav a { margin-right:1rem; text-decoration:none; font-weight:bold; cursor:pointer; }
    nav a.active { text-decoration:underline; }
    table { border-collapse:collapse; width:100%; margin-top:1rem; }
    th, td { border:1px solid #333; padding:0.5rem; text-align:center; }
    input, select { padding:0.3rem; width:100%; box-sizing:border-box; }
    .btn { padding:0.5rem 1rem; background:#007acc; color:#fff; border:none; cursor:pointer; }
    .btn:hover { background:#005fa3; }
    .btn.danger { background:#dc3545; }
    .btn.danger:hover { background:#c82333; }
    .editable-cell { cursor:text; }
    .date-section { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ccc; background-color: #f9f9f9; }
    .date-section h4 { margin-top: 0; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    .fieldset-container { border: 1px solid #ccc; padding: 1.5rem; margin-bottom: 2rem; border-radius: 5px; background-color: #fff; }
    .fieldset-container legend { font-weight: bold; font-size: 1.2em; padding: 0 0.5rem; color: #007acc; }
    .btn-group { margin-top: 1.5rem; }
    .hidden { display: none; }
    #preview table { border-collapse: collapse; width: 100%; }
    #preview td, #preview th { border: 2px solid #000; padding: 8px; text-align: center; }
    #preview .editable-cell { background-color: #f9f9f9; }
    #preview .editable-cell:focus { background-color: #fff; outline: 2px solid #007acc; }
    .empty-amount-cell { background-color: #fffacd; cursor: text; }
  </style>
</head>
<body>

<nav>
  <a href="#" id="nav-products" class="active">Prodotti</a>
  <a href="#" id="nav-template">Genera Template</a>
</nav>

<!-- Sezione Prodotti -->
<div id="products-section">
  <h2>Gestione Prodotti</h2>
  
  <div id="edit-product-form" class="hidden">
    <h3>Modifica Prodotto</h3>
    <table>
      <tr><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Salva</th></tr>
      <tr>
        <td><input id="edit-name" required></td>
        <td><input id="edit-price" type="number" step="0.01" required></td>
        <td><button class="btn" onclick="saveEditProduct()">Salva</button></td>
      </tr>
    </table>
    <button class="btn" onclick="cancelEdit()">Annulla</button>
    <hr>
  </div>

  <table>
    <tr><th>Nome Prodotto</th><th>Prezzo (‚Ç¨)</th><th>Aggiungi</th></tr>
    <tr>
      <td><input id="new-product-name" placeholder="Nome prodotto" required></td>
      <td><input id="new-product-price" type="number" step="0.01" placeholder="‚Ç¨" required></td>
      <td><button class="btn" onclick="addProduct()">Aggiungi</button></td>
    </tr>
  </table>

  <table id="products-table">
    <tr><th>ID</th><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Modifica</th><th>Elimina</th></tr>
  </table>
</div>

<!-- Sezione Template -->
<div id="template-section" class="hidden">
  <h2>Genera Template</h2>
  
  <div id="template-form">
    <div class="fieldset-container">
        <legend>Dati Cliente e Data</legend>
        <div class="form-group">
            <label for="cliente">Cliente:</label>
            <input id="cliente" required>
        </div>

        <div id="date_section_0" class="form-group">
            <label for="date1">Data:</label>
            <input type="date" id="date1" required>
            <table id="single-date-table">
                <thead>
                    <tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="form-group">
            <label><input type="checkbox" id="multi_date"> Abilita date multiple</label>
        </div>

        <div id="multi_date_section" style="display:none;" class="fieldset-container">
            <legend>Date Aggiuntive</legend>
            <div id="date_sections_container">
            </div>
            <button type="button" id="add_date_btn" class="btn" style="margin-top: 1rem;">Aggiungi Data</button>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn" onclick="generatePreview()">Genera & Preview</button>
    </div>
  </div>

  <div id="preview-section" class="hidden">
    <h3>Preview (valori calcolati)</h3>
    <div id="preview"></div>
    <p><button class="btn" onclick="downloadExcel()">Download .xlsx</button></p>
    <button class="btn" onclick="backToForm()">Torna al Form</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Global variables
let products = [];
let currentEditId = null;
let dateCounter = 0;
let previewData = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    setupEventListeners();
    document.getElementById('date1').value = new Date().toISOString().slice(0,10);
});

function setupEventListeners() {
    document.getElementById('nav-products').addEventListener('click', () => showSection('products'));
    document.getElementById('nav-template').addEventListener('click', () => showSection('template'));
    
    document.getElementById('multi_date').addEventListener('change', toggleMultiDateSection);
    document.getElementById('add_date_btn').addEventListener('click', () => addDateSection());
}

function showSection(section) {
    document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
    document.querySelectorAll('[id$="-section"]').forEach(s => s.classList.add('hidden'));
    
    if (section === 'products') {
        document.getElementById('nav-products').classList.add('active');
        document.getElementById('products-section').classList.remove('hidden');
        loadProducts();
    } else if (section === 'template') {
        document.getElementById('nav-template').classList.add('active');
        document.getElementById('template-section').classList.remove('hidden');
        buildSingleDateTable();
    }
}

function addProduct() {
    const name = document.getElementById('new-product-name').value.trim();
    const price = parseFloat(document.getElementById('new-product-price').value);
    
    if (!name || isNaN(price)) {
        alert('Inserisci nome e prezzo validi');
        return;
    }
    
    const newId = Math.max(...products.map(p => p.id), 0) + 1;
    products.push({ id: newId, name: name, price: price });
    
    document.getElementById('new-product-name').value = '';
    document.getElementById('new-product-price').value = '';
    loadProducts();
}

function loadProducts() {
    const table = document.getElementById('products-table');
    const tbody = table.querySelector('tbody') || table;
    
    // Clear existing rows except header
    while (tbody.rows.length > 1) {
        tbody.deleteRow(1);
    }
    
    if (products.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = '<td colspan="5">Nessun prodotto presente.</td>';
        return;
    }
    
    products.forEach(product => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${product.id}</td>
            <td>${product.name}</td>
            <td>${product.price.toFixed(2).replace('.', ',')}</td>
            <td><button class="btn" onclick="editProduct(${product.id})">‚úèÔ∏è</button></td>
            <td><button class="btn danger" onclick="deleteProduct(${product.id})">üóëÔ∏è</button></td>
        `;
    });
}

function editProduct(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    
    currentEditId = id;
    document.getElementById('edit-name').value = product.name;
    document.getElementById('edit-price').value = product.price;
    document.getElementById('edit-product-form').classList.remove('hidden');
}

function saveEditProduct() {
    const name = document.getElementById('edit-name').value.trim();
    const price = parseFloat(document.getElementById('edit-price').value);
    
    if (!name || isNaN(price)) {
        alert('Inserisci nome e prezzo validi');
        return;
    }
    
    const productIndex = products.findIndex(p => p.id === currentEditId);
    if (productIndex !== -1) {
        products[productIndex].name = name;
        products[productIndex].price = price;
        cancelEdit();
        loadProducts();
    }
}

function cancelEdit() {
    currentEditId = null;
    document.getElementById('edit-product-form').classList.add('hidden');
}

function deleteProduct(id) {
    if (confirm('Elimina questo prodotto?')) {
        products = products.filter(p => p.id !== id);
        loadProducts();
    }
}

function buildSingleDateTable() {
    const tbody = document.querySelector('#single-date-table tbody');
    tbody.innerHTML = '';
    
    products.forEach((product, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><input name="colli1_${index}" type="number" min="0" value="0"></td>
            <td>${product.name}</td>
            <td><input name="kg1_${index}" type="number" step="0.01" min="0" value="0"></td>
        `;
    });
}

function toggleMultiDateSection() {
    const checkbox = document.getElementById('multi_date');
    const multiSection = document.getElementById('multi_date_section');
    const singleSection = document.getElementById('date_section_0');
    const container = document.getElementById('date_sections_container');
    
    if (checkbox.checked) {
        multiSection.style.display = 'block';
        singleSection.style.display = 'none';
        if (container.children.length === 0) {
            addDateSection(0, new Date().toISOString().slice(0,10));
        }
    } else {
        multiSection.style.display = 'none';
        singleSection.style.display = 'block';
        container.innerHTML = '';
        dateCounter = 0;
    }
}

function addDateSection(initialCounter = null, initialDate = '') {
    const currentCounter = initialCounter !== null ? initialCounter : ++dateCounter;
    const container = document.getElementById('date_sections_container');
    
    const newSection = document.createElement('div');
    newSection.classList.add('date-section');
    newSection.setAttribute('data-date-index', currentCounter);
    
    let tableRows = '';
    products.forEach((product, index) => {
        tableRows += `
            <tr>
                <td><input name="dates[${currentCounter}][colli][${index}]" type="number" min="0" value="0"></td>
                <td>${product.name}</td>
                <td><input name="dates[${currentCounter}][kg][${index}]" type="number" step="0.01" min="0" value="0"></td>
            </tr>
        `;
    });
    
    newSection.innerHTML = `
        <h4>Data ${currentCounter + 1}</h4>
        <div class="form-group">
          <label>Data:</label>
          <input type="date" name="dates[${currentCounter}][date]" value="${initialDate || new Date().toISOString().slice(0,10)}" required>
        </div>
        <table>
            <thead>
                <tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
        <button type="button" class="btn danger remove-date-btn" style="margin-top: 10px;">Rimuovi Data</button>
    `;
    
    container.appendChild(newSection);
    
    newSection.querySelector('.remove-date-btn').addEventListener('click', function() {
        newSection.remove();
        if (document.getElementById('multi_date').checked && container.children.length === 0) {
            addDateSection(0, new Date().toISOString().slice(0,10));
        }
    });
}

function generatePreview() {
    const cliente = document.getElementById('cliente').value.trim();
    if (!cliente) {
        alert('Inserisci il nome del cliente');
        return;
    }
    
    const allEntries = [];
    const multiDate = document.getElementById('multi_date').checked;
    
    if (multiDate) {
        const dateSections = document.querySelectorAll('.date-section');
        dateSections.forEach(section => {
            const dateInput = section.querySelector('input[type="date"]');
            const date = dateInput.value;
            const entries = [];
            
            const colliInputs = section.querySelectorAll('input[name*="[colli]"]');
            const kgInputs = section.querySelectorAll('input[name*="[kg]"]');
            
            colliInputs.forEach((colliInput, index) => {
                const colli = parseInt(colliInput.value) || 0;
                const kg = parseFloat(kgInputs[index].value) || 0;
                
                if (colli > 0 || kg > 0) {
                    entries.push({
                        c: colli,
                        name: products[index].name,
                        kg: kg,
                        price: products[index].price
                    });
                }
            });
            
            if (entries.length > 0) {
                allEntries.push({ date: date, entries: entries });
            }
        });
    } else {
        const date = document.getElementById('date1').value;
        const entries = [];
        
        products.forEach((product, index) => {
            const colliInput = document.querySelector(`input[name="colli1_${index}"]`);
            const kgInput = document.querySelector(`input[name="kg1_${index}"]`);
            
            const colli = parseInt(colliInput.value) || 0;
            const kg = parseFloat(kgInput.value) || 0;
            
            if (colli > 0 || kg > 0) {
                entries.push({
                    c: colli,
                    name: product.name,
                    kg: kg,
                    price: product.price
                });
            }
        });
        
        if (entries.length > 0) {
            allEntries.push({ date: date, entries: entries });
        }
    }
    
    if (allEntries.length === 0) {
        alert('Inserisci almeno un prodotto con quantit√† > 0');
        return;
    }
    
    generatePreviewTable(cliente, allEntries);
}

function generatePreviewTable(cliente, allEntries) {
    let html = `
        <table id="preview-table" style="width:100%; border-collapse:collapse;">
            <tr>
                <td colspan="5" style="text-align:center; font-weight:bold; font-size:12px; border:2px solid #000; padding:8px;">
                    NOTA DI VENDITA | ${cliente}
                </td>
            </tr>
            <tr style="font-weight:bold;">
                <td style="border:2px solid #000; padding:8px; text-align:center; width:8%;">C</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:35%;">PRODOTTO</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:12%;">KG</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:20%;">PREZZO</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:25%;">IMPORTO</td>
            </tr>
    `;
    
    previewData = [];
    let totalAmount = 0;
    
    allEntries.forEach((dateSection, sectionIndex) => {
        if (sectionIndex > 0) {
            html += '<tr><td colspan="5" style="border-top:3px double #000;"></td></tr>';
        }
        
        const displayDate = formatDate(dateSection.date);
        html += `<tr><td colspan="5" style="border:2px solid #000; padding:8px;">Data: ${displayDate}</td></tr>`;
        
        previewData.push({ type: 'date_label', date: dateSection.date });
        
        dateSection.entries.forEach(entry => {
            const amount = entry.kg * entry.price;
            totalAmount += amount;
            
            html += `
                <tr>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" data-col-type="colli">${entry.c}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" data-col-type="product">${entry.name}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" class="editable-cell" data-col-type="kg" contenteditable="true">${entry.kg.toFixed(2)}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" class="editable-cell" data-col-type="price" contenteditable="true">‚Ç¨${entry.price.toFixed(2)}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" class="editable-cell" data-col-type="amount" contenteditable="true">‚Ç¨${amount.toFixed(2)}</td>
                </tr>
            `;
            
            previewData.push({
                type: 'product_row',
                colli: entry.c,
                product_name: entry.name,
                kg: entry.kg,
                price: entry.price,
                amount: amount
            });
        });
    });
    
    // Fill remaining rows up to 22 data rows
    const maxDataRows = 22;
    let currentDataRows = allEntries.reduce((sum, section) => sum + section.entries.length, 0) + allEntries.length; // +sections for date labels
    
    for (let i = currentDataRows; i < maxDataRows; i++) {
        html += `<tr>
            <td colspan="4" style="border:2px solid #000; padding:8px;"></td>
            <td style="border:2px solid #000; padding:8px; text-align:center;" class="empty-amount-cell editable-cell" data-col-type="empty-amount" contenteditable="true">‚Ç¨0,00</td>
        </tr>`;
    }
    
    html += `
        <tr style="font-weight:bold;">
            <td colspan="4" style="border:2px solid #000; padding:8px; text-align:center;">TOTALE</td>
            <td id="totalAmount" style="border:2px solid #000; padding:8px; text-align:center;">‚Ç¨${totalAmount.toFixed(2)}</td>
        </tr>
    </table>`;
    
    document.getElementById('preview').innerHTML = html;
    document.getElementById('template-form').classList.add('hidden');
    document.getElementById('preview-section').classList.remove('hidden');
    
    setupPreviewEventListeners();
}

function setupPreviewEventListeners() {
    const table = document.getElementById('preview-table');
    const totalCell = document.getElementById('totalAmount');
    
    table.addEventListener('input', function(event) {
        const target = event.target;
        if (target.classList.contains('editable-cell') && target.dataset.colType !== 'total') {
            const row = target.closest('tr');
            const type = target.dataset.colType;
            
            if (type === 'empty-amount') {
                // Per le celle vuote dell'importo, aggiorna solo il totale
                recalcTotal();
            } else {
                // Per le altre celle, ricalcola la riga e poi il totale
                recalcRow(row, type);
                recalcTotal();
            }
        }
    });
    
    function clean(v) {
        return parseFloat((v || '').replace('‚Ç¨', '').replace(/[^0-9,.-]/g,'').replace(',','.')) || 0;
    }
    
    function fmt(v) {
        const num = parseFloat(v);
        if (isNaN(num)) return '‚Ç¨0,00';
        return '‚Ç¨' + num.toFixed(2);
    }
    
    function recalcRow(row, modifiedType) {
        const kgCell = row.querySelector('[data-col-type=kg]');
        const priceCell = row.querySelector('[data-col-type=price]');
        const amountCell = row.querySelector('[data-col-type=amount]');
        
        if (!kgCell || !priceCell || !amountCell) return;
        
        let kg = clean(kgCell.textContent);
        let price = clean(priceCell.textContent);
        let amount = clean(amountCell.textContent);
        
        if (modifiedType === 'kg' || modifiedType === 'price') {
            amount = kg * price;
        }
        
        kgCell.textContent = kg.toFixed(2);
        priceCell.textContent = fmt(price);
        amountCell.textContent = fmt(amount);
    }
    
    function recalcTotal() {
        let sum = 0;
        // Somma tutte le celle dell'importo (sia prodotti che celle vuote)
        table.querySelectorAll('[data-col-type=amount], [data-col-type=empty-amount]').forEach(cell => {
            sum += clean(cell.textContent);
        });
        totalCell.textContent = fmt(sum);
    }
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('it-IT');
}

function backToForm() {
    document.getElementById('template-form').classList.remove('hidden');
    document.getElementById('preview-section').classList.add('hidden');
}

function downloadExcel() {
    const table = document.getElementById('preview-table');
    const cliente = document.getElementById('cliente').value.trim();
    
    // Creiamo i dati dell'Excel manualmente per una struttura ottimizzata
    const ws = XLSX.utils.aoa_to_sheet([]);
    
    // Analizziamo la tabella HTML per estrarre i dati
    const rows = table.querySelectorAll('tr');
    
    rows.forEach((row, rowIndex) => {
        const cells = row.querySelectorAll('td, th');
        
        // Se √® la riga del totale
        if (row.querySelector('#totalAmount')) {
            const totalValue = row.querySelector('#totalAmount').textContent.replace('‚Ç¨', '').replace('.', ',');
            const finalRowData = ['', '', '', '', 'TOTALE', totalValue]; // TOTALE e importo totale
            XLSX.utils.sheet_add_aoa(ws, [finalRowData], { origin: `A${rowIndex + 1}` });
        } 
        // Se √® la riga dell'header
        else if (cells.length === 5 && cells[4].textContent.trim() === 'IMPORTO') {
            const rowData = ['', '', 'C', 'PRODOTTO', 'KG', 'PREZZO', 'IMPORTO'];
            XLSX.utils.sheet_add_aoa(ws, [rowData], { origin: `A${rowIndex + 1}` });
        }
        // Se la riga ha 5 colonne (le righe dati normali)
        else if (cells.length === 5) {
            const rowData = ['', '']; // Due colonne vuote all'inizio (A e B)
            
            // Aggiungiamo tutti i valori dalle 5 colonne
            for (let i = 0; i < 5; i++) {
                let cellText = cells[i].textContent.trim();
                // Rimuoviamo il simbolo ‚Ç¨ e sostituiamo il punto con la virgola per i numeri
                if (cellText.startsWith('‚Ç¨')) {
                    cellText = cellText.replace('‚Ç¨', '').replace('.', ',');
                }
                rowData.push(cellText);
            }
            
            XLSX.utils.sheet_add_aoa(ws, [rowData], { origin: `A${rowIndex + 1}` });
        }
        // Per le altre righe (header principale, date, etc.)
        else {
            const rowData = ['', '']; // Due colonne vuote all'inizio (A e B)
            
            // Se √® una riga con colspan, distribuiamo il contenuto
            if (cells.length === 1 && cells[0].getAttribute('colspan')) {
                const cellText = cells[0].textContent.trim();
                const colspanValue = parseInt(cells[0].getAttribute('colspan'));
                const finalRowData = ['', '']; // A e B vuote
                finalRowData.push(cellText); // Il testo nella colonna C
                // Riempiamo le altre colonne fino al colspan
                for (let i = 1; i < colspanValue; i++) {
                    finalRowData.push('');
                }
                XLSX.utils.sheet_add_aoa(ws, [finalRowData], { origin: `A${rowIndex + 1}` });
            } else {
                // Per le righe normali
                cells.forEach((cell) => {
                    let cellText = cell.textContent.trim();
                    if (cellText.startsWith('‚Ç¨')) {
                        cellText = cellText.replace('‚Ç¨', '').replace('.', ',');
                    }
                    rowData.push(cellText);
                });
                XLSX.utils.sheet_add_aoa(ws, [rowData], { origin: `A${rowIndex + 1}` });
            }
        }
    });
    
    // Impostiamo il range del foglio per includere fino alla colonna G
    const range = XLSX.utils.decode_range(ws['!ref']);
    ws['!ref'] = XLSX.utils.encode_range({
        s: { r: range.s.r, c: 0 }, // Inizia da A1
        e: { r: range.e.r, c: 6 }  // Finisce alla colonna G
    });
    
    // Stile per bordi spessi per le colonne con dati (C-G)
    const borderStyle = {
        style: 'thick',
        color: { rgb: '000000' }
    };
    
    for (let row = range.s.r; row <= range.e.r; row++) {
        for (let col = 2; col <= 6; col++) { // Dalle colonne C a G (indici 2-6)
            const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
            if (!ws[cellAddress]) continue;
            
            ws[cellAddress].s = {
                border: {
                    top: borderStyle,
                    bottom: borderStyle,
                    left: borderStyle,
                    right: borderStyle
                }
            };
        }
    }
    
    // Creiamo il workbook
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Nota di Vendita");
    
    // Salviamo il file
    XLSX.writeFile(wb, `${cliente}.xlsx`);
}
console.log("funziono");
</script>

</body>
</html>