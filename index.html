<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>PAGANPESCA SRL | Gestione Vendite</title>
  <link rel="stylesheet" href="css/style.css">
    <link rel="icon" 
        type="image/png" 
        href="images/shrimp.png">
</head>
<body>

<nav>
  <a href="#" id="nav-products" class="active">Prodotti</a>
  <a href="#" id="nav-template">Genera Template</a>
</nav>

<div id="products-section">
  <h2>Gestione Prodotti</h2>
  
  <div class="file-controls">
    <h4>Gestione File Prodotti</h4>
    <button class="btn success" onclick="downloadProductsJSON()">üì• Scarica Prodotti (JSON)</button>
    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadProductsFromFile(event)">
    <button class="btn" onclick="document.getElementById('fileInput').click()">üì§ Carica Prodotti (JSON)</button>
    <button class="btn danger" onclick="clearAllProducts()">üóëÔ∏è Cancella Tutti</button>
    <div id="status-message"></div>
  </div>
  
  <div id="edit-product-form" class="hidden">
    <h3>Modifica Prodotto</h3>
    <table>
      <tr><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Salva</th></tr>
      <tr>
        <td><input id="edit-name" required></td>
        <td><input id="edit-price" type="number" step="0.01" required></td>
        <td><button class="btn" onclick="saveEditProduct()">Salva</button></td>
      </tr>
    </table>
    <button class="btn" onclick="cancelEdit()">Annulla</button>
    <hr>
  </div>

  <table>
    <tr><th>Nome Prodotto</th><th>Prezzo (‚Ç¨)</th><th>Aggiungi</th></tr>
    <tr>
      <td><input id="new-product-name" placeholder="Nome prodotto" required></td>
      <td><input id="new-product-price" type="number" step="0.01" placeholder="‚Ç¨" required></td>
      <td><button class="btn" onclick="addProduct()">Aggiungi</button></td>
    </tr>
  </table>

  <table id="products-table">
    <tr><th>ID</th><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Modifica</th><th>Elimina</th></tr>
  </table>
</div>

<div id="template-section" class="hidden">
  <h2>Genera Template</h2>
  
  <div id="template-form">
    <div class="fieldset-container">
        <legend>Dati Cliente e Data</legend>
        <div class="form-group">
            <label for="cliente">Cliente:</label>
            <input id="cliente" required>
        </div>

        <div id="date_section_0" class="form-group">
            <label for="date1">Data:</label>
            <input type="date" id="date1" required>
            <table id="single-date-table">
                <thead>
                    <tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="form-group">
            <label><input type="checkbox" id="multi_date"> Abilita date multiple</label>
        </div>

        <div id="multi_date_section" style="display:none;" class="fieldset-container">
            <legend>Date Aggiuntive</legend>
            <div id="date_sections_container">
            </div>
            <button type="button" id="add_date_btn" class="btn" style="margin-top: 1rem;">Aggiungi Data</button>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn" onclick="generatePreview()">Genera & Preview</button>
    </div>
  </div>

  <div id="preview-section" class="hidden">
    <h3>Preview (valori calcolati)</h3>
    <div id="preview"></div>
    <p><button onclick="downloadExcelWithExcelJS()">Download Excel</button></p>
    <button class="btn" onclick="backToForm()">Torna al Form</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

<script>
// Persistenza in localStorage
function saveProductsToStorage() {
  localStorage.setItem('products', JSON.stringify(products));
}

function loadProductsFromStorage() {
  const stored = localStorage.getItem('products');
  if (stored) {
    try {
      products = JSON.parse(stored);
    } catch (e) {
      console.error('Errore parsing localStorage products:', e);
      products = [];
    }
  }
}

// Global variables
let products = [];
let currentEditId = null;
let dateCounter = 0;
let previewData = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadProductsFromStorage();
    loadProducts();
    setupEventListeners();
    document.getElementById('date1').value = new Date().toISOString().slice(0,10);
});

// Funzioni per gestione JSON prodotti
function showStatusMessage(message, isError = false) {
    const statusDiv = document.getElementById('status-message');
    statusDiv.innerHTML = `<div class="status-message ${isError ? 'status-error' : 'status-success'}">${message}</div>`;
    setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
}

function downloadProductsJSON() {
    if (products.length === 0) {
        showStatusMessage('Nessun prodotto da salvare!', true);
        return;
    }
    const dataStr = JSON.stringify(products, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url; link.download = 'prodotti.json';
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
    URL.revokeObjectURL(url);
    showStatusMessage(`File prodotti.json scaricato con ${products.length} prodotti!`);
}

function loadProductsFromFile(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loaded = JSON.parse(e.target.result);
            if (!Array.isArray(loaded)) throw new Error('Array atteso');
            loaded.forEach(p => { if (!p.id||!p.name||typeof p.price!=='number') throw new Error(); });
            products = loaded;
            saveProductsToStorage();
            loadProducts();
            showStatusMessage(`Caricati ${products.length} prodotti dal file JSON!`);
        } catch (err) {
            showStatusMessage(`Errore: ${err.message}`, true);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function clearAllProducts() {
    if (!products.length) { showStatusMessage('Nessun prodotto da cancellare!', true); return; }
    if (confirm(`Cancelli tutti i ${products.length} prodotti?`)) {
        products = [];
        saveProductsToStorage();
        loadProducts();
        showStatusMessage('Tutti i prodotti sono stati cancellati!');
    }
}

function setupEventListeners() {
    document.getElementById('nav-products').addEventListener('click', () => showSection('products'));
    document.getElementById('nav-template').addEventListener('click', () => showSection('template'));
    document.getElementById('multi_date').addEventListener('change', toggleMultiDateSection);
    document.getElementById('add_date_btn').addEventListener('click', () => addDateSection());
}

function showSection(section) {
    document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
    document.querySelectorAll('[id$="-section"]').forEach(s => s.classList.add('hidden'));
    if (section==='products') {
        document.getElementById('nav-products').classList.add('active');
        document.getElementById('products-section').classList.remove('hidden');
        loadProducts();
    } else {
        document.getElementById('nav-template').classList.add('active');
        document.getElementById('template-section').classList.remove('hidden');
        buildSingleDateTable();
    }
}

function addProduct() {
    const name = document.getElementById('new-product-name').value.trim();
    const price = parseFloat(document.getElementById('new-product-price').value);
    if (!name||isNaN(price)) { showStatusMessage('Inserisci nome e prezzo validi', true); return; }
    const newId = Math.max(0, ...products.map(p=>p.id)) + 1;
    products.push({ id:newId, name, price });
    saveProductsToStorage();
    loadProducts();
    showStatusMessage(`Prodotto "${name}" aggiunto!`);
}

function loadProducts() {
    const tbl = document.getElementById('products-table');
    const tbody = tbl.querySelector('tbody')||tbl;
    while (tbody.rows.length>1) tbody.deleteRow(1);
    if (!products.length) {
        const r=tbody.insertRow(); r.innerHTML='<td colspan="5">Nessun prodotto presente.<br><small>Aggiungi o carica JSON.</small></td>';
        return;
    }
    products.forEach(p=>{
        const r=tbody.insertRow();
        r.innerHTML=`<td>${p.id}</td><td>${p.name}</td><td>${p.price.toFixed(2).replace('.',',')}</td>
            <td><button class="btn" onclick="editProduct(${p.id})">‚úèÔ∏è</button></td>
            <td><button class="btn danger" onclick="deleteProduct(${p.id})">üóëÔ∏è</button></td>`;
    });
}

function editProduct(id) {
    const prod = products.find(p=>p.id===id); if(!prod) return;
    currentEditId=id;
    document.getElementById('edit-name').value=prod.name;
    document.getElementById('edit-price').value=prod.price;
    document.getElementById('edit-product-form').classList.remove('hidden');
}

function saveEditProduct() {
    const name=document.getElementById('edit-name').value.trim();
    const price=parseFloat(document.getElementById('edit-price').value);
    if(!name||isNaN(price)) { showStatusMessage('Inserisci nome e prezzo validi',true); return; }
    const idx=products.findIndex(p=>p.id===currentEditId);
    if(idx!==-1){ products[idx].name=name; products[idx].price=price; }
    saveProductsToStorage();
    cancelEdit(); loadProducts(); showStatusMessage('Prodotto modificato con successo!');
}

function cancelEdit() { currentEditId=null; document.getElementById('edit-product-form').classList.add('hidden'); }

function deleteProduct(id) {
    const prod=products.find(p=>p.id===id); if(!prod)return;
    if(confirm(`Elimina "${prod.name}"?`)){ products=products.filter(p=>p.id!==id); saveProductsToStorage(); loadProducts(); showStatusMessage(`Prodotto "${prod.name}" eliminato!`); }
}
function buildSingleDateTable() {
    const tbody = document.querySelector('#single-date-table tbody');
    tbody.innerHTML = '';
    
    if (products.length === 0) {
        const row = tbody.insertRow();
        row.innerHTML = '<td colspan="3">Nessun prodotto disponibile. Vai alla sezione Prodotti per aggiungerne.</td>';
        return;
    }
    
    products.forEach((product, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><input name="colli1_${index}" type="number" min="" value=""></td>
            <td>${product.name}</td>
            <td><input name="kg1_${index}" type="number"  min="" value=""></td>
        `;
    });
}

function toggleMultiDateSection() {
    const checkbox = document.getElementById('multi_date');
    const multiSection = document.getElementById('multi_date_section');
    const singleSection = document.getElementById('date_section_0');
    const container = document.getElementById('date_sections_container');
    
    if (checkbox.checked) {
        multiSection.style.display = 'block';
        singleSection.style.display = 'none';
        if (container.children.length === 0) {
            addDateSection(0, new Date().toISOString().slice(0,10));
        }
    } else {
        multiSection.style.display = 'none';
        singleSection.style.display = 'block';
        container.innerHTML = '';
        dateCounter = 0;
    }
}

function addDateSection(initialCounter = null, initialDate = '') {
    if (products.length === 0) {
        showStatusMessage('Aggiungi prima alcuni prodotti nella sezione Prodotti!', true);
        return;
    }
    
    const currentCounter = initialCounter !== null ? initialCounter : ++dateCounter;
    const container = document.getElementById('date_sections_container');
    
    const newSection = document.createElement('div');
    newSection.classList.add('date-section');
    newSection.setAttribute('data-date-index', currentCounter);
    
    let tableRows = '';
    products.forEach((product, index) => {
        tableRows += `
            <tr>
                <td><input name="dates[${currentCounter}][colli][${index}]" type="number" min="0" value="0"></td>
                <td>${product.name}</td>
                <td><input name="dates[${currentCounter}][kg][${index}]" type="number" step="0.01" min="0" value="0"></td>
            </tr>
        `;
    });
    
    newSection.innerHTML = `
        <h4>Data ${currentCounter + 1}</h4>
        <div class="form-group">
          <label>Data:</label>
          <input type="date" name="dates[${currentCounter}][date]" value="${initialDate || new Date().toISOString().slice(0,10)}" required>
        </div>
        <table>
            <thead>
                <tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
        <button type="button" class="btn danger remove-date-btn" style="margin-top: 10px;">Rimuovi Data</button>
    `;
    
    container.appendChild(newSection);
    
    newSection.querySelector('.remove-date-btn').addEventListener('click', function() {
        newSection.remove();
        if (document.getElementById('multi_date').checked && container.children.length === 0) {
            addDateSection(0, new Date().toISOString().slice(0,10));
        }
    });
}

function generatePreview() {
    const cliente = document.getElementById('cliente').value.trim();
    if (!cliente) {
        showStatusMessage('Inserisci il nome del cliente', true);
        return;
    }
    
    if (products.length === 0) {
        showStatusMessage('Nessun prodotto disponibile per generare il template!', true);
        return;
    }
    
    const allEntries = [];
    const multiDate = document.getElementById('multi_date').checked;
    
    if (multiDate) {
        const dateSections = document.querySelectorAll('.date-section');
        dateSections.forEach(section => {
            const dateInput = section.querySelector('input[type="date"]');
            const date = dateInput.value;
            const entries = [];
            
            const colliInputs = section.querySelectorAll('input[name*="[colli]"]');
            const kgInputs = section.querySelectorAll('input[name*="[kg]"]');
            
            colliInputs.forEach((colliInput, index) => {
                const colli = parseInt(colliInput.value) || 0;
                const kg = parseFloat(kgInputs[index].value) || 0;
                
                if (colli > 0 || kg > 0) {
                    entries.push({
                        c: colli,
                        name: products[index].name,
                        kg: kg,
                        price: products[index].price
                    });
                }
            });
            
            if (entries.length > 0) {
                allEntries.push({ date: date, entries: entries });
            }
        });
    } else {
        const date = document.getElementById('date1').value;
        const entries = [];
        
        products.forEach((product, index) => {
            const colliInput = document.querySelector(`input[name="colli1_${index}"]`);
            const kgInput = document.querySelector(`input[name="kg1_${index}"]`);
            
            const colli = parseInt(colliInput.value) || 0;
            const kg = parseFloat(kgInput.value) || 0;
            
            if (colli > 0 || kg > 0) {
                entries.push({
                    c: colli,
                    name: product.name,
                    kg: kg,
                    price: product.price
                });
            }
        });
        
        if (entries.length > 0) {
            allEntries.push({ date: date, entries: entries });
        }
    }
    
    if (allEntries.length === 0) {
        showStatusMessage('Inserisci almeno un prodotto con quantit√† > 0', true);
        return;
    }
    
    generatePreviewTable(cliente, allEntries);
}

function generatePreviewTable(cliente, allEntries) {
    let html = `
        <table id="preview-table" style="width:100%; border-collapse:collapse;">
            <tr>
                <td colspan="5" style="text-align:center; font-weight:bold; font-size:12px; border:2px solid #000; padding:8px;">
                    NOTA DI VENDITA | ${cliente}
                </td>
            </tr>
            <tr style="font-weight:bold;">
                <td style="border:2px solid #000; padding:8px; text-align:center; width:8%;">C</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:35%;">PRODOTTO</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:12%;">KG</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:20%;">PREZZO</td>
                <td style="border:2px solid #000; padding:8px; text-align:center; width:25%;">IMPORTO</td>
            </tr>
    `;
    
    previewData = [];
    let totalAmount = 0;
    
    allEntries.forEach((dateSection, sectionIndex) => {
        if (sectionIndex > 0) {
            html += '<tr><td colspan="5" style="border-top:3px double #000;"></td></tr>';
        }
        
        const displayDate = formatDate(dateSection.date);
        html += `<tr><td colspan="5" style="border:2px solid #000; padding:8px;">Data: ${displayDate}</td></tr>`;
        
        previewData.push({ type: 'date_label', date: dateSection.date });
        
        dateSection.entries.forEach(entry => {
            const amount = entry.kg * entry.price;
            totalAmount += amount;
            
            html += `
                <tr>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" data-col-type="colli">${entry.c}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" data-col-type="product">${entry.name}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" class="editable-cell" data-col-type="kg" contenteditable="true">${entry.kg.toFixed(2)}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" class="editable-cell" data-col-type="price" contenteditable="true">‚Ç¨${entry.price.toFixed(2)}</td>
                    <td style="border:2px solid #000; padding:8px; text-align:center;" class="editable-cell" data-col-type="amount" contenteditable="true">‚Ç¨${amount.toFixed(2)}</td>
                </tr>
            `;
            
            previewData.push({
                type: 'product_row',
                colli: entry.c,
                product_name: entry.name,
                kg: entry.kg,
                price: entry.price,
                amount: amount
            });
        });
    });
    
    // Fill remaining rows up to 22 data rows
    const maxDataRows = 22;
    let currentDataRows = allEntries.reduce((sum, section) => sum + section.entries.length, 0) + allEntries.length; // +sections for date labels
    
    for (let i = currentDataRows; i < maxDataRows; i++) {
        html += `<tr>
            <td colspan="4" style="border:2px solid #000; padding:8px;"></td>
            <td style="border:2px solid #000; padding:8px; text-align:center;" class="empty-amount-cell editable-cell" data-col-type="empty-amount" contenteditable="true">‚Ç¨0,00</td>
        </tr>`;
    }
    
    html += `
        <tr style="font-weight:bold;">
            <td colspan="4" style="border:2px solid #000; padding:8px; text-align:center;">TOTALE</td>
            <td id="totalAmount" style="border:2px solid #000; padding:8px; text-align:center;">‚Ç¨${totalAmount.toFixed(2)}</td>
        </tr>
    </table>`;
    
    document.getElementById('preview').innerHTML = html;
    document.getElementById('template-form').classList.add('hidden');
    document.getElementById('preview-section').classList.remove('hidden');
    
    setupPreviewEventListeners();
}

function setupPreviewEventListeners() {
    const table = document.getElementById('preview-table');
    const totalCell = document.getElementById('totalAmount');
    
    table.addEventListener('input', function(event) {
        const target = event.target;
        if (target.classList.contains('editable-cell') && target.dataset.colType !== 'total') {
            const row = target.closest('tr');
            const type = target.dataset.colType;
            
            if (type === 'empty-amount') {
                // Per le celle vuote dell'importo, aggiorna solo il totale
                recalcTotal();
            } else {
                // Per le altre celle, ricalcola la riga e poi il totale
                recalcRow(row, type);
                recalcTotal();
            }
        }
    });
    
    function clean(v) {
        return parseFloat((v || '').replace('‚Ç¨', '').replace(/[^0-9,.-]/g,'').replace(',','.')) || 0;
    }
    
    function fmt(v) {
        const num = parseFloat(v);
        if (isNaN(num)) return '‚Ç¨0,00';
        return '‚Ç¨' + num.toFixed(2);
    }
    
    function recalcRow(row, modifiedType) {
        const kgCell = row.querySelector('[data-col-type=kg]');
        const priceCell = row.querySelector('[data-col-type=price]');
        const amountCell = row.querySelector('[data-col-type=amount]');
        
        if (!kgCell || !priceCell || !amountCell) return;
        
        let kg = clean(kgCell.textContent);
        let price = clean(priceCell.textContent);
        let amount = clean(amountCell.textContent);
        
        if (modifiedType === 'kg' || modifiedType === 'price') {
            amount = kg * price;
        }
        
        kgCell.textContent = kg.toFixed(2);
        priceCell.textContent = fmt(price);
        amountCell.textContent = fmt(amount);
    }
    
    function recalcTotal() {
        let sum = 0;
        // Somma tutte le celle dell'importo (sia prodotti che celle vuote)
        table.querySelectorAll('[data-col-type=amount], [data-col-type=empty-amount]').forEach(cell => {
            sum += clean(cell.textContent);
        });
        totalCell.textContent = fmt(sum);
    }
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('it-IT');
}

function backToForm() {
    document.getElementById('template-form').classList.remove('hidden');
    document.getElementById('preview-section').classList.add('hidden');
}

async function downloadExcelWithExcelJS() {
    const table = document.getElementById('preview-table');
    const cliente = document.getElementById('cliente').value.trim();

    // Crea un nuovo workbook e worksheet
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Nota di Vendita');
    
    const rows = table.querySelectorAll('tr');
    const headerRows = new Set();
    const dateRows   = new Set();
    let totalRowIdx  = -1;

    // Popola il foglio (colonne B‚ÄìF anzich√© B‚ÄìG)
    rows.forEach((row, i) => {
        const cells = row.querySelectorAll('td, th');
        const excelRow = worksheet.getRow(i + 1);

        if (cells.length === 1 && cells[0].colSpan === 5) {
            excelRow.getCell(2).value = cells[0].textContent.trim();
            worksheet.mergeCells(i+1, 2, i+1, 6);  // da B a F
            dateRows.add(i);
        }
        else if (cells.length === 5 && cells[4].textContent.trim() === 'IMPORTO') {
            ['C','PRODOTTO','KG','PREZZO','IMPORTO']
              .forEach((v,j) => excelRow.getCell(2 + j).value = v);
            headerRows.add(i);
        }
        else if (cells.length === 5) {
            const [colli, name, kg, pr, am] = Array.from(cells).map(td=>td.textContent.trim());
            excelRow.getCell(2).value = colli;
            excelRow.getCell(3).value = name;
            excelRow.getCell(4).value = parseFloat(kg).toFixed(2).replace('.', ',');
            excelRow.getCell(5).value = pr;
            excelRow.getCell(6).value = am;
        }
        else if (cells.length === 2 && cells[1].classList.contains('empty-amount-cell')) {
            excelRow.getCell(6).value = cells[1].textContent.trim();
        }
        else if (row.querySelector('#totalAmount')) {
            excelRow.getCell(5).value = 'TOTALE';
            excelRow.getCell(6).value = row.querySelector('#totalAmount').textContent.trim();
            totalRowIdx = i;
        }
    });

    // Stili e bordi su B‚ÄìF
// Stili e bordi su B‚ÄìF
for (let r = 1; r <= rows.length; r++) {
  for (let c = 2; c <= 6; c++) {
    const cell = worksheet.getCell(r, c);
    // bordi
    cell.border = {
      top:    { style: 'medium', color: { argb: 'FF000000' } },
      left:   { style: 'medium', color: { argb: 'FF000000' } },
      bottom: { style: 'medium', color: { argb: 'FF000000' } },
      right:  { style: 'medium', color: { argb: 'FF000000' } }
    };

    // font e allineamento con size 14
    const idx = r - 1;
    if (headerRows.has(idx) || idx === totalRowIdx) {
      cell.font      = { bold: true, size: 14 };
      cell.alignment = { horizontal: 'center' };
    } 
    else if (dateRows.has(idx)) {
      cell.font      = { bold: true, size: 14 };
      cell.alignment = { horizontal: 'left' };
    } 
    else {
      cell.font      = { size: 14 };
      cell.alignment = { horizontal: 'left' };
    }
  }
}
    // Larghezze colonne A‚ÄìF
    worksheet.getColumn(1).width = 14;
    worksheet.getColumn(2).width = 12;
    worksheet.getColumn(3).width = 18;
    worksheet.getColumn(4).width = 12;
    worksheet.getColumn(5).width = 12;
    worksheet.getColumn(6).width = 16;

    // Genera e scarica
    const buffer = await workbook.xlsx.writeBuffer();
    const blob   = new Blob([buffer], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url    = URL.createObjectURL(blob);
    const a      = document.createElement('a');
    a.href = url; a.download = `${cliente}.xlsx`; a.click();
    URL.revokeObjectURL(url);
}

</script>

</body>
</html>