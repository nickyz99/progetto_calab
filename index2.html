<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Vendite</title>
  <style>
    body { font-family:Arial,sans-serif; margin:2rem; }
    nav a { margin-right:1rem; text-decoration:none; font-weight:bold; cursor:pointer; }
    nav a.active { text-decoration:underline; }
    table { border-collapse:collapse; width:100%; margin-top:1rem; }
    th, td { border:1px solid #333; padding:0.5rem; text-align:center; }
    input, select { padding:0.3rem; width:100%; box-sizing:border-box; }
    .btn { padding:0.5rem 1rem; background:#007acc; color:#fff; border:none; cursor:pointer; }
    .btn:hover { background:#005fa3; }
    .btn.danger { background:#dc3545; }
    .btn.danger:hover { background:#c82333; }
    .editable-cell { cursor:text; }
    .date-section { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ccc; background-color: #f9f9f9; }
    .date-section h4 { margin-top: 0; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.3rem; font-weight: bold; }
    .fieldset-container { border: 1px solid #ccc; padding: 1.5rem; margin-bottom: 2rem; border-radius: 5px; background-color: #fff; }
    .fieldset-container legend { font-weight: bold; font-size: 1.2em; padding: 0 0.5rem; color: #007acc; }
    .btn-group { margin-top: 1.5rem; }
    .hidden { display: none; }
    #preview table { border-collapse: collapse; width: 100%; }
    #preview td, #preview th { border: 1px solid #000; padding: 8px; text-align: center; }
    #preview .editable-cell { background-color: #f9f9f9; }
    #preview .editable-cell:focus { background-color: #fff; outline: 2px solid #007acc; }
  </style>
</head>
<body>

<nav>
  <a id="nav-products" class="active">Prodotti</a>
  <a id="nav-template">Genera Template</a>
</nav>

<!-- Sezione Prodotti -->
<div id="products-section">
  <h2>Gestione Prodotti</h2>
  <div id="edit-product-form" class="hidden">
    <h3>Modifica Prodotto</h3>
    <table>
      <tr><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Salva</th></tr>
      <tr>
        <td><input id="edit-name" required></td>
        <td><input id="edit-price" type="number" step="0.01" required></td>
        <td><button class="btn" onclick="saveEditProduct()">Salva</button></td>
      </tr>
    </table>
    <button class="btn" onclick="cancelEdit()">Annulla</button>
    <hr>
  </div>

  <table>
    <tr><th>Nome Prodotto</th><th>Prezzo (‚Ç¨)</th><th>Aggiungi</th></tr>
    <tr>
      <td><input id="new-product-name" placeholder="Nome prodotto" required></td>
      <td><input id="new-product-price" type="number" step="0.01" placeholder="‚Ç¨" required></td>
      <td><button class="btn" onclick="addProduct()">Aggiungi</button></td>
    </tr>
  </table>

  <table id="products-table">
    <tr><th>ID</th><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Modifica</th><th>Elimina</th></tr>
  </table>
</div>

<!-- Sezione Template -->
<div id="template-section" class="hidden">
  <h2>Genera Template</h2>
  <div id="template-form">
    <div class="fieldset-container">
        <legend>Dati Cliente e Data</legend>
        <div class="form-group">
            <label for="cliente">Cliente:</label>
            <input id="cliente" required>
        </div>

        <div id="date_section_0" class="form-group">
            <label for="date1">Data:</label>
            <input type="date" id="date1" required>
            <table id="single-date-table">
                <thead>
                    <tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="form-group">
            <label><input type="checkbox" id="multi_date"> Abilita date multiple</label>
        </div>

        <div id="multi_date_section" class="fieldset-container hidden">
            <legend>Date Aggiuntive</legend>
            <div id="date_sections_container"></div>
            <button type="button" id="add_date_btn" class="btn">Aggiungi Data</button>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn" onclick="generatePreview()">Genera & Preview</button>
    </div>
  </div>

  <div id="preview-section" class="hidden">
    <h3>Preview (valori calcolati)</h3>
    <div id="preview"></div>
    <p><button class="btn" onclick="downloadExcel()">Download .xlsx</button></p>
    <button class="btn" onclick="backToForm()">Torna al Form</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// Prodotti
let products = JSON.parse(localStorage.getItem('products') || '[]');
let currentEditId = null;
function saveProducts() { localStorage.setItem('products', JSON.stringify(products)); }
function renderProducts() {
  const tbl = document.getElementById('products-table');
  tbl.innerHTML = '<tr><th>ID</th><th>Nome</th><th>Prezzo (‚Ç¨)</th><th></th><th></th></tr>';
  if (products.length === 0) {
    const r = tbl.insertRow(); r.insertCell().colSpan = 5; r.cells[0].textContent = 'Nessun prodotto presente.';
    return;
  }
  products.forEach(p => {
    const r = tbl.insertRow();
    r.insertCell().textContent = p.id;
    r.insertCell().textContent = p.name;
    r.insertCell().textContent = p.price.toFixed(2).replace('.', ',');
    r.insertCell().innerHTML = `<button class="btn" onclick="editProduct(${p.id})">‚úèÔ∏è</button>`;
    r.insertCell().innerHTML = `<button class="btn danger" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>`;
  });
}
function addProduct() {
  const name = document.getElementById('new-product-name').value.trim();
  const price = parseFloat(document.getElementById('new-product-price').value);
  if (!name || isNaN(price)) { alert('Inserisci nome e prezzo validi'); return; }
  const id = products.length ? products[products.length - 1].id + 1 : 1;
  products.push({ id, name, price }); saveProducts(); renderProducts();
}
function editProduct(id) {
  const p = products.find(x => x.id === id); if (!p) return;
  currentEditId = id; document.getElementById('edit-name').value = p.name; document.getElementById('edit-price').value = p.price;
  document.getElementById('edit-product-form').classList.remove('hidden');
}
function saveEditProduct() {
  const name = document.getElementById('edit-name').value.trim();
  const price = parseFloat(document.getElementById('edit-price').value);
  if (!name || isNaN(price)) { alert('Inserisci nome e prezzo validi'); return; }
  const i = products.findIndex(x => x.id === currentEditId);
  products[i] = { id: currentEditId, name, price }; saveProducts(); cancelEdit(); renderProducts();
}
function cancelEdit() { currentEditId = null; document.getElementById('edit-product-form').classList.add('hidden'); }
function deleteProduct(id) { if (confirm('Elimina questo prodotto?')) { products = products.filter(x => x.id !== id); saveProducts(); renderProducts(); } }

document.getElementById('nav-products').addEventListener('click', () => showSection('products'));
document.getElementById('nav-template').addEventListener('click', () => showSection('template'));
function showSection(sec) {
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
  document.getElementById(`${sec}-section`).classList.remove('hidden');
  document.getElementById(`products-section` === `${sec}-section` ? 'template-section' : 'products-section').classList.add('hidden');
  document.getElementById(`nav-${sec}`).classList.add('active');
  if (sec === 'template') initTemplate(); else renderProducts();
}

// Template
let dateCount = 0;
function initTemplate() {
  document.getElementById('template-form').classList.remove('hidden');
  document.getElementById('preview-section').classList.add('hidden');
  document.getElementById('cliente').value = '';
  document.getElementById('date1').value = new Date().toISOString().slice(0,10);
  document.getElementById('multi_date_section').classList.add('hidden');
  dateCount = 0; buildSingleTable();
}
function buildSingleTable() {
  const tb = document.querySelector('#single-date-table tbody'); tb.innerHTML = '';
  products.forEach((p,i) => {
    const r = tb.insertRow();
    r.insertCell().innerHTML = `<input data-i="${i}" data-col="colli" type="number" min="0" value="0">`;
    r.insertCell().textContent = p.name;
    r.insertCell().innerHTML = `<input data-i="${i}" data-col="kg" type="number" step="0.01" min="0" value="0">`;
  });
}
document.getElementById('multi_date').addEventListener('change', e => {
  document.getElementById('multi_date_section').classList.toggle('hidden', !e.target.checked);
});
function addDateSection() {
  const cnt = dateCount++;
  const cont = document.getElementById('date_sections_container');
  const div = document.createElement('div'); div.className = 'date-section';
  let rows = '';
  products.forEach((p,i) => {
    rows += `<tr><td><input data-i="${i}" data-col="colli" type="number" min="0" value="0"></td><td>${p.name}</td><td><input data-i="${i}" data-col="kg" type="number" step="0.01" min="0" value="0"></td></tr>`;
  });
  div.innerHTML = `
    <h4>Data ${cnt+1}</h4>
    <input type="date" value="${new Date().toISOString().slice(0,10)}">
    <table><thead><tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr></thead><tbody>${rows}</tbody></table>
    <button class="btn danger" onclick="this.parentNode.remove()">Rimuovi Data</button>`;
  cont.appendChild(div);
}

function generatePreview() {
  const cliente = document.getElementById('cliente').value.trim();
  if (!cliente) { alert('Inserisci il nome cliente'); return; }
  const entries = [];
  const multi = !document.getElementById('multi_date_section').classList.contains('hidden');
  function gather(date, rows) {
    const items = [];
    rows.forEach(r => {
      const i = +r.querySelector('[data-i]').dataset.i;
      const c = +(r.querySelector('[data-col="colli"]').value) || 0;
      const kg= +(r.querySelector('[data-col="kg"]').value) || 0;
      if (c || kg) items.push({ c, name: products[i].name, kg, price: products[i].price });
    });
    if (items.length) entries.push({ date, items });
  }
  if (multi) {
    document.querySelectorAll('#date_sections_container .date-section').forEach(div => {
      const date = div.querySelector('input[type=date]').value;
      gather(date, div.querySelectorAll('tbody tr'));
    });
  } else {
    const date = document.getElementById('date1').value;
    gather(date, document.querySelectorAll('#single-date-table tbody tr'));
  }
  if (!entries.length) { alert('Nessuna riga da inserire'); return; }
  renderPreviewTable(cliente, entries);
}

function renderPreviewTable(cliente, allEntries) {
  const container = document.getElementById('preview');
  let html = '<table id="preview-table">';
  html += `<tr><td colspan="7" style="font-weight:bold;">NOTA DI VENDITA | ${cliente}</td></tr>`;
  html += '<tr><th></th><th></th><th>C</th><th>PRODOTTO</th><th>KG</th><th>PREZZO</th><th>IMPORTO</th></tr>';
  let total = 0;
  allEntries.forEach((sec,i) => {
    if (i>0) html += '<tr><td colspan="7" style="border-top:3px double #000;"></td></tr>';
    html += `<tr><td></td><td></td><td colspan="5">Data: ${sec.date}</td></tr>`;
    sec.items.forEach(it => {
      const amt = it.kg * it.price;
      total += amt;
      html += `<tr>${[ '', '', it.c, it.name, it.kg.toFixed(2), '‚Ç¨'+it.price.toFixed(2), '‚Ç¨'+amt.toFixed(2) ]
        .map((v,ci)=>`<td class="${ci>=4?'editable-cell':''}" contenteditable="${ci>=4}" data-col="${ci}">${v}</td>`).join('')}</tr>`;
    });
  });
  const dataRows = document.getElementById('preview-table')?.rows.length || 0;
  for (let i=dataRows; i<22; i++) html += '<tr><td></td><td></td><td>0</td><td></td><td></td><td></td><td class="editable-cell" contenteditable="true">‚Ç¨0,00</td></tr>';
  html += `<tr><td></td><td></td><td></td><td></td><td></td><td style="font-weight:bold;">TOTALE</td><td style="font-weight:bold;">‚Ç¨${total.toFixed(2)}</td></tr>`;
  html += '</table>';
  container.innerHTML = html;
  document.getElementById('template-form').classList.add('hidden');
  document.getElementById('preview-section').classList.remove('hidden');
  setupPreviewEvents();
}

function setupPreviewEvents() {
  const tbl = document.getElementById('preview-table');
  const totCell = tbl.rows[tbl.rows.length-1].cells[6];
  tbl.addEventListener('input', e => {
    const td = e.target;
    const col = +td.dataset.col;
    if (col >=4 && col <=6) {
      const r = td.parentNode;
      const kg = parseFloat(r.cells[4].textContent.replace('‚Ç¨','').replace(',','.'))||0;
      const pr = parseFloat(r.cells[5].textContent.replace('‚Ç¨','').replace(',','.'))||0;
      const am = kg * pr;
      r.cells[6].textContent = '‚Ç¨'+am.toFixed(2);
      // recalc total
      let sum=0;
      Array.from(tbl.rows).slice(2,-1).forEach(row => {
        sum += parseFloat(row.cells[6].textContent.replace('‚Ç¨','').replace(',','.'))||0;
      });
      totCell.textContent = '‚Ç¨'+sum.toFixed(2);
    }
  });
}

function backToForm() {
  document.getElementById('template-form').classList.remove('hidden');
  document.getElementById('preview-section').classList.add('hidden');
}

function downloadExcel() {
  const cliente = document.getElementById('cliente').value.trim();
  const tbl = document.getElementById('preview-table');
  const wb = XLSX.utils.table_to_book(tbl, { sheet: 'NotaVendita', raw: true });
  const ws = wb.Sheets['NotaVendita'];
  // Darker border
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let R = range.s.r; R <= range.e.r; ++R) {
    for (let C = range.s.c; C <= range.e.c; ++C) {
      const addr = XLSX.utils.encode_cell({ r: R, c: C });
      if (!ws[addr]) continue;
      ws[addr].s = { border: { top: { style: 'thick' }, bottom: { style: 'thick' }, left: { style: 'thick' }, right: { style: 'thick' } } };
    }
  }
  XLSX.writeFile(wb, `${cliente}.xlsx`);
}
</script>

</body>
</html>
