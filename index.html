<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestione Vendite</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    nav { margin-bottom: 1rem; }
    nav button { margin-right: 1rem; padding: 0.5rem 1rem; border: none; background: #007acc; color: #fff; cursor: pointer; }
    nav button.active { background: #005fa3; }
    section { display: none; }
    section.active { display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #333; padding: 0.5rem; text-align: center; }
    input, button { padding: 0.3rem; margin: 0.2rem 0; }
    .btn { background: #007acc; color: #fff; border: none; cursor: pointer; }
    .btn:hover { background: #005fa3; }
    .fieldset-container { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background: #f9f9f9; }
    .date-section { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background: #fff; }
    .editable-cell { cursor: text; }
  </style>
</head>
<body>

  <nav>
    <button id="btn-products" class="active">Prodotti</button>
    <button id="btn-template">Genera Template</button>
  </nav>

  <section id="view-products" class="active">
    <h2>Gestione Prodotti</h2>
    <form id="form-product" class="fieldset-container">
      <input type="hidden" id="product-id">
      <div>
        <label>Nome Prodotto:<br><input id="input-name" required></label>
      </div>
      <div>
        <label>Prezzo (‚Ç¨):<br><input id="input-price" type="number" step="0.01" required></label>
      </div>
      <div style="margin-top:0.5rem;">
        <button type="submit" class="btn">Salva</button>
        <button type="button" id="btn-reset" class="btn">Annulla</button>
      </div>
    </form>
    <table>
      <thead>
        <tr><th>ID</th><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Modifica</th><th>Elimina</th></tr>
      </thead>
      <tbody id="products-tbody"></tbody>
    </table>
  </section>

  <section id="view-template">
    <h2>Genera Template</h2>
    <div class="fieldset-container">
      <div>
        <label>Cliente:<br><input id="input-cliente" required></label>
      </div>
      <div id="single-date-section" class="fieldset-container">
        <legend>Data Unica</legend>
        <div>
          <label>Data:<br><input id="date1" type="date"></label>
        </div>
        <table>
          <thead><tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr></thead>
          <tbody id="single-tbody"></tbody>
        </table>
      </div>
      <div>
        <label><input id="multi-date-checkbox" type="checkbox"> Abilita date multiple</label>
      </div>
      <div id="multi-container"></div>
      <div style="margin-top:1rem;">
        <button id="add-date" class="btn">Aggiungi Data</button>
        <button id="btn-generate" class="btn">Preview & Download</button>
      </div>
    </div>
    <div id="preview-container"></div>
  </section>

<script>
(() => {
  const STORAGE_KEY = 'products';
  function loadProducts(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }
  function saveProducts(a){ localStorage.setItem(STORAGE_KEY, JSON.stringify(a)); }

  // NAV
  const btnP = document.getElementById('btn-products'),
        btnT = document.getElementById('btn-template'),
        vP   = document.getElementById('view-products'),
        vT   = document.getElementById('view-template');
  btnP.onclick = ()=>toggle('products');
  btnT.onclick = ()=>toggle('template');
  function toggle(v){
    btnP.classList.toggle('active', v==='products');
    btnT.classList.toggle('active', v==='template');
    vP.classList.toggle('active', v==='products');
    vT.classList.toggle('active', v==='template');
    if(v==='template') renderSingle(); else renderProducts();
  }

  // CRUD Prodotti
  let editId = null;
  const formProd = document.getElementById('form-product');
  formProd.onsubmit = e=>{
    e.preventDefault();
    const n = document.getElementById('input-name').value.trim(),
          p = parseFloat(document.getElementById('input-price').value);
    if(!n||isNaN(p)) return;
    let arr = loadProducts();
    if(editId!==null){
      arr = arr.map(x=> x.id===editId ? {id:editId,name:n,price:p} : x);
      editId = null;
    } else {
      const id = arr.length?arr[arr.length-1].id+1:1;
      arr.push({id,name:n,price:p});
    }
    saveProducts(arr);
    renderProducts();
    formProd.reset();
  };
  document.getElementById('btn-reset').onclick=()=>{ formProd.reset(); editId=null; };

  function renderProducts(){
    const tb = document.getElementById('products-tbody');
    tb.innerHTML='';
    loadProducts().forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${x.id}</td><td>${x.name}</td><td>‚Ç¨ ${x.price.toFixed(2)}</td>
        <td><button class="btn edit" data-id="${x.id}">‚úèÔ∏è</button></td>
        <td><button class="btn delete" data-id="${x.id}">üóëÔ∏è</button></td>`;
      tb.appendChild(tr);
    });
  }
  document.getElementById('products-tbody').onclick = e=>{
    const t=e.target, id=+t.dataset.id;
    if(t.classList.contains('delete')){
      if(confirm('Elimina?')){
        saveProducts(loadProducts().filter(x=>x.id!==id));
        renderProducts();
      }
    }
    if(t.classList.contains('edit')){
      const p = loadProducts().find(x=>x.id===id);
      editId=id;
      document.getElementById('input-name').value=p.name;
      document.getElementById('input-price').value=p.price;
    }
  };

  // Template
  const singleTbody = document.getElementById('single-tbody'),
        multiCb     = document.getElementById('multi-date-checkbox'),
        multiC      = document.getElementById('multi-container'),
        addBtn      = document.getElementById('add-date'),
        genBtn      = document.getElementById('btn-generate');
  let secCount=0;
  function renderSingle(){
    singleTbody.innerHTML='';
    loadProducts().forEach((p,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input data-i="${i}" data-type="colli" type="number" min="0" value="0"></td>
        <td>${p.name}</td>
        <td><input data-i="${i}" data-type="kg" type="number" step="0.01" min="0" value="0"></td>`;
      singleTbody.appendChild(tr);
    });
  }
  function addSec(){
    const div=document.createElement('div');
    div.className='date-section';
    div.innerHTML=`
      <h4>Data ${++secCount}</h4>
      <label>Data:<br><input type="date"></label>
      <table>
        <thead><tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr></thead>
        <tbody></tbody>
      </table>
      <button class="btn rm">Rimuovi</button>`;
    const bd=div.querySelector('tbody');
    loadProducts().forEach((p,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input data-i="${i}" data-type="colli" type="number" min="0" value="0"></td>
        <td>${p.name}</td>
        <td><input data-i="${i}" data-type="kg" type="number" step="0.01" min="0" value="0"></td>`;
      bd.appendChild(tr);
    });
    div.querySelector('.rm').onclick=()=>div.remove();
    multiC.appendChild(div);
  }
  multiCb.onchange=()=>{
    multiC.innerHTML=''; secCount=0;
    if(multiCb.checked) addSec();
  };
  addBtn.onclick=e=>{ e.preventDefault(); if(multiCb.checked) addSec(); };

  // Preview & Download
  genBtn.onclick=()=>{
    const cliente = document.getElementById('input-cliente').value.trim()||'Cliente';
    const prods = loadProducts();
    const sections=[];
    function gather(sec,date){
      const rows=sec.querySelectorAll('tbody tr');
      const ents=[];
      rows.forEach(r=>{
        const i=+r.querySelector('[data-i]').dataset.i;
        const c=parseFloat(r.querySelector('[data-type="colli"]').value)||0;
        const kg=parseFloat(r.querySelector('[data-type="kg"]').value)||0;
        if(c||kg) ents.push({c,name:prods[i].name,kg,price:prods[i].price,amount:kg*prods[i].price});
      });
      if(ents.length) sections.push({date,entries:ents});
    }
    if(multiCb.checked){
      document.querySelectorAll('#multi-container .date-section').forEach(div=>gather(div,div.querySelector('input[type=date]').value));
    } else gather(document.getElementById('single-date-section'),document.getElementById('date1').value);

    // Build AOA
    const aoa=[];
    aoa.push([`NOTA DI VENDITA | ${cliente}`]);
    aoa.push(['C','PRODOTTO','KG','PREZZO','IMPORTO']);
    let first=true;
    sections.forEach(s=>{
      if(!first) aoa.push([]);
      first=false;
      aoa.push([`Data: ${s.date}`]);
      s.entries.forEach(e=>aoa.push([e.c,e.name,e.kg,e.price,e.amount]));
    });
    const dataRows = aoa.filter(r=>r.length===5).length;
    for(let i=dataRows;i<22;i++) aoa.push([0,'',0,0,0]);
    const total=sections.reduce((sum,s)=>sum+s.entries.reduce((s2,e)=>s2+e.amount,0),0);
    aoa.push(['TOTALE','','','',total]);

    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet(aoa);
    ws['!merges']=[{s:{r:0,c:0},e:{r:0,c:4}}];
    ws['!cols']=[{wpx:50},{wpx:200},{wpx:60},{wpx:120},{wpx:140}];
    XLSX.utils.book_append_sheet(wb,ws,'Vendite');

    // Preview with sheet_to_html
    const html = XLSX.utils.sheet_to_html(ws);
    const div=document.createElement('div');
    div.innerHTML = html;
    const tbl=div.querySelector('table');
    tbl.id='preview';
    // rendi editabili
    Array.from(tbl.rows).forEach((tr,i)=>{
      if(i>1 && i<aoa.length-1){
        const cells=tr.children;
        if(cells.length>=5){
          [2,3,4].forEach(idx=>{
            cells[idx].setAttribute('contenteditable','true');
            cells[idx].classList.add('editable-cell');
          });
        }
      }
    });
    const pc=document.getElementById('preview-container');
    pc.innerHTML=''; pc.appendChild(div);

    // recalc funcs
    const clean=v=>parseFloat(v.replace(/[^0-9,.-]/g,'').replace(',','.'))||0;
    const fmt=v=>v.toLocaleString('it-IT',{style:'currency',currency:'EUR'});
    function recalcRow(tr){
      const [,,kgC,prC,amC]=tr.children;
      const kg=clean(kgC.textContent), pr=clean(prC.textContent), am=kg*pr;
      kgC.textContent=kg.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
      prC.textContent=fmt(pr);
      amC.textContent=fmt(am);
    }
    function recalcAll(){
      let sum=0; const rows=tbl.rows;
      for(let i=2;i<rows.length-1;i++){
        const tr=rows[i]; if(tr.children.length<5) continue;
        recalcRow(tr);
        sum+=clean(tr.children[4].textContent);
      }
      rows[rows.length-1].children[4].textContent=fmt(sum);
    }
    tbl.addEventListener('input',()=>recalcAll());
    recalcAll();

    // download
    XLSX.writeFile(wb,`${cliente}.xlsx`);
  };

  // init
  renderProducts();
  renderSingle();
})();
</script>

</body>
</html>
