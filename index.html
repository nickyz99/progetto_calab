<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Vendite</title>
  <style>
    body { font-family:Arial,sans-serif; margin:2rem; }
    nav a { margin-right:1rem; text-decoration:none; font-weight:bold; cursor:pointer; }
    nav a.active { text-decoration:underline; }
    table { border-collapse:collapse; width:100%; margin-top:1rem; }
    th, td { border:1px solid #333; padding:0.5rem; text-align:center; }
    input, select { padding:0.3rem; width:100%; box-sizing:border-box; }
    .btn { padding:0.5rem 1rem; background:#007acc; color:#fff; border:none; cursor:pointer; }
    .btn:hover { background:#005fa3; }
    .btn.danger { background:#dc3545; }
    .btn.danger:hover { background:#c82333; }
    .editable-cell { cursor:text; background:#f9f9f9; }
    .editable-cell:focus { background:#fff; outline:2px solid #007acc; }
    .date-section { margin-bottom:1.5rem; padding:1rem; border:1px solid #ccc; background:#f9f9f9; }
    .hidden { display:none; }
    #preview table { border-collapse: collapse; width:100%; }
    #preview th, #preview td { border:2px solid #000; padding:8px; }
  </style>
</head>
<body>

<nav>
  <a href="#" id="nav-products" class="active">Prodotti</a>
  <a href="#" id="nav-template">Genera Template</a>
</nav>

<!-- Prodotti -->
<div id="products-section">
  <h2>Gestione Prodotti</h2>
  <div id="edit-product-form" class="hidden">
    <h3>Modifica Prodotto</h3>
    <table>
      <tr><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Salva</th></tr>
      <tr>
        <td><input id="edit-name"></td>
        <td><input id="edit-price" type="number" step="0.01"></td>
        <td><button class="btn" onclick="saveEditProduct()">Salva</button></td>
      </tr>
    </table>
    <button class="btn" onclick="cancelEdit()">Annulla</button>
    <hr>
  </div>

  <table>
    <tr><th>Nome Prodotto</th><th>Prezzo (‚Ç¨)</th><th>Aggiungi</th></tr>
    <tr>
      <td><input id="new-product-name" placeholder="Nome prodotto"></td>
      <td><input id="new-product-price" type="number" step="0.01" placeholder="Prezzo"></td>
      <td><button class="btn" onclick="addProduct()">Aggiungi</button></td>
    </tr>
  </table>

  <table id="products-table">
    <tr><th>ID</th><th>Nome</th><th>Prezzo (‚Ç¨)</th><th>Modifica</th><th>Elimina</th></tr>
  </table>
</div>

<!-- Template -->
<div id="template-section" class="hidden">
  <h2>Genera Template</h2>
  <div id="template-form">
    <div class="fieldset-container">
      <legend>Dati Cliente e Data</legend>
      <div class="form-group">
        <label>Cliente: <input id="cliente"></label>
      </div>
      <div id="single-group" class="form-group">
        <label>Data: <input id="date1" type="date"></label>
        <table id="single-date-table">
          <thead><tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="form-group">
        <label><input id="multi-date" type="checkbox"> Date multiple</label>
      </div>
      <div id="multi-group" class="fieldset-container hidden">
        <legend>Date Aggiuntive</legend>
        <div id="date-sections"></narrative>
        <button class="btn" onclick="addDateSection()">Aggiungi Data</button>
      </div>
    </div>
    <div class="btn-group">
      <button class="btn" onclick="generatePreview()">Genera & Preview</button>
    </div>
  </div>
  <div id="preview-section" class="hidden">
    <h3>Preview</h3>
    <div id="preview"></div>
    <button class="btn" onclick="downloadExcel()">Download .xlsx</button>
    <button class="btn" onclick="backToForm()">Modifica</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let products = JSON.parse(localStorage.getItem('products')||'[]'), editId=null, dateCnt=0;
function saveProducts(){localStorage.setItem('products',JSON.stringify(products));}
function loadProducts(){const tbl=document.getElementById('products-table');tbl.innerHTML='<tr><th>ID</th><th>Nome</th><th>Prezzo (‚Ç¨)</th><th></th><th></th></tr>';products.forEach(p=>{const r=tbl.insertRow();r.insertCell().innerText=p.id;r.insertCell().innerText=p.name;r.insertCell().innerText=p.price.toFixed(2);r.insertCell().innerHTML=`<button onclick="editProduct(${p.id})">‚úèÔ∏è</button>`;r.insertCell().innerHTML=`<button class="btn danger" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>`;});if(!products.length){const r=tbl.insertRow();r.insertCell().colSpan=5;r.cells[0].innerText='Nessun prodotto';}}
function addProduct(){const n=document.getElementById('new-product-name').value.trim(),pr=parseFloat(document.getElementById('new-product-price').value);if(!n||isNaN(pr))return;const id=products.length?products[products.length-1].id+1:1;products.push({id,name:n,price:pr});saveProducts();loadProducts();}
function editProduct(id){const p=products.find(x=>x.id===id);if(!p)return;editId=id;document.getElementById('edit-name').value=p.name;document.getElementById('edit-price').value=p.price;document.getElementById('edit-product-form').classList.remove('hidden');}
function saveEditProduct(){const n=document.getElementById('edit-name').value.trim(),pr=parseFloat(document.getElementById('edit-price').value);if(!n||isNaN(pr))return;products=products.map(p=>p.id===editId?{id:p.id,name:n,price:pr}:p);saveProducts();cancelEdit();loadProducts();}
function cancelEdit(){editId=null;document.getElementById('edit-product-form').classList.add('hidden');}
function deleteProduct(id){products=products.filter(p=>p.id!==id);saveProducts();loadProducts();}
function showSection(s){document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));document.querySelectorAll('[id$="-section"]').forEach(d=>d.classList.add('hidden'));document.getElementById(`nav-${s}`).classList.add('active');document.getElementById(`${s}-section`).classList.remove('hidden');if(s==='template')initTemplate();else loadProducts();}
document.getElementById('nav-products').onclick=()=>showSection('products');document.getElementById('nav-template').onclick=()=>showSection('template');

function initTemplate(){document.getElementById('template-form').classList.remove('hidden');document.getElementById('preview-section').classList.add('hidden');document.getElementById('cliente').value='';document.getElementById('date1').value=new Date().toISOString().substr(0,10);dateCnt=0;document.getElementById('single-date-table').querySelector('tbody').innerHTML='';products.forEach((p,i)=>{const r=document.querySelector('#single-date-table tbody').insertRow();r.insertCell().innerHTML=`<input data-i="${i}" data-col="colli" type="number" min="0" value="0">`;r.insertCell().innerText=p.name;r.insertCell().innerHTML=`<input data-i="${i}" data-col="kg" type="number" step="0.01" min="0" value="0">`;});document.getElementById('multi-date').checked=false;document.getElementById('multi_date_section').classList.add('hidden');document.getElementById('date_sections_container').innerHTML='';}
document.getElementById('multi_date').onchange=e=>document.getElementById('multi_date_section').classList.toggle('hidden',!e.target.checked);
function addDateSection(){const idx=dateCnt++;const c=document.getElementById('date_sections_container'),div=document.createElement('div');div.className='date-section';let rows='';products.forEach((p,i)=>rows+=`<tr><td><input data-i="${i}" data-col="colli" type="number" min="0" value="0"></td><td>${p.name}</td><td><input data-i="${i}" data-col="kg" type="number" step="0.01" min="0" value="0"></td></tr>`);div.innerHTML=`<h4>Data ${idx+1}</h4><input type="date" value="${new Date().toISOString().substr(0,10)}"><table><thead><tr><th>Colli</th><th>Prodotto</th><th>KG</th></tr></thead><tbody>${rows}</tbody></table><button class="btn danger" onclick="this.parentNode.remove()">Rimuovi</button>`;c.appendChild(div);}

function generatePreview(){const cli=document.getElementById('cliente').value.trim();if(!cli)return;const multi=!document.getElementById('multi_date_section').classList.contains('hidden');let arr=[];const gather=(dt,rows)=>{let items=[];rows.forEach(r=>{const i=+r.querySelector('[data-i]').dataset.i,c=+(r.querySelector('[data-col="colli"]').value)||0,kg=+(r.querySelector('[data-col="kg"]').value)||0;if(c||kg)items.push({c,name:products[i].name,kg,price:products[i].price});});if(items.length)arr.push({date:dt,items});};if(multi)document.querySelectorAll('#date_sections_container .date-section').forEach(div=>gather(div.querySelector('input[type=date]').value,div.querySelectorAll('tbody tr')));else gather(document.getElementById('date1').value,document.querySelectorAll('#single-date-table tbody tr'));if(!arr.length)return;renderPreview(cli,arr);}
function renderPreview(cli,arr){let html='<table id="preview-table">';html+='<tr>'+Array(7).fill('<td></td>').join('')+'</tr>';html+='<tr><td></td><td></td><td colspan="5" style="font-weight:bold;">NOTA DI VENDITA | '+cli+'</td></tr>';html+='<tr><th></th><th></th><th>C</th><th>PRODOTTO</th><th>KG</th><th>PREZZO</th><th>IMPORTO</th></tr>';let tot=0;arr.forEach((sec,i)=>{if(i>0)html+='<tr><td colspan="7" style="border-top:3px double #000;"></td></tr>';html+='<tr><td></td><td></td><td colspan="5">Data: '+sec.date+'</td></tr>';sec.items.forEach(it=>{const amt=it.kg*it.price;tot+=amt;html+='<tr>'+['','',it.c,it.name,it.kg.toFixed(2),'‚Ç¨'+it.price.toFixed(2),'‚Ç¨'+amt.toFixed(2)].map((v,ci)=>`<td ${ci>=4?'class="editable-cell" contenteditable="true"':''} data-col="${ci}">${v}</td>`).join('')+'</tr>'});});const rows=document.getElementById('preview-table')?.rows.length||0;for(let i=rows;i<22;i++)html+='<tr><td></td><td></td><td>0</td><td></td><td></td><td></td><td class="editable-cell" contenteditable="true">‚Ç¨0,00</td></tr>';html+='<tr>'+['','','', '','','TOTALE','‚Ç¨'+tot.toFixed(2)].map(v=>`<td style="font-weight:bold;">${v}</td>`).join('')+'</tr>'+'</table>';document.getElementById('preview').innerHTML=html;document.getElementById('template-form').classList.add('hidden');document.getElementById('preview-section').classList.remove('hidden');setupPreview();}
function setupPreview(){const tbl=document.getElementById('preview-table'),last=tbl.rows[tbl.rows.length-1].cells[6];tbl.addEventListener('input',e=>{const td=e.target;if(td.classList.contains('editable-cell')){const r=td.parentNode,kg=+r.cells[4].textContent.replace('‚Ç¨','')||0,pr=+r.cells[5].textContent.replace('‚Ç¨','')||0;const am=kg*pr;r.cells[6].textContent='‚Ç¨'+am.toFixed(2);let sum=0;Array.from(tbl.rows).slice(2,-1).forEach(row=>sum+=+row.cells[6].textContent.replace('‚Ç¨','')||0);last.textContent='‚Ç¨'+sum.toFixed(2);}});}
function backToForm(){document.getElementById('template-form').classList.remove('hidden');document.getElementById('preview-section').classList.add('hidden');}
function downloadExcel(){const tbl=document.getElementById('preview-table'),cli=document.getElementById('cliente').value;const wb=XLSX.utils.table_to_book(tbl,{sheet:'NotaVendita',raw:true});const ws=wb.Sheets['NotaVendita'],rng=XLSX.utils.decode_range(ws['!ref']);for(let R=rng.s.r;R<=rng.e.r;R++)for(let C=rng.s.c;C<=rng.e.c;C++){const addr=XLSX.utils.encode_cell({r:R,c:C});if(!ws[addr])continue;ws[addr].s={border:{top:{style:'thick'},bottom:{style:'thick'},left:{style:'thick'},right:{style:'thick'}}};}XLSX.writeFile(wb,`${cli}.xlsx`);}
</script>

</body>
</html>
